module.exports = function ({ gh, owner }) {
    return async function sync_vulnerability_alerts(repo) {
        console.log(`[RUN] syncing vulnerability alerts for ${repo.name}`)

        let vulnerability_alerts_synced

        try {
            const resp = await gh.request('GET /repos/{owner}/{repo}/vulnerability-alerts', {
                owner,
                repo: repo.name,
                mediaType: {
                    previews: [
                        'dorian',
                    ],
                },
            })

            if (resp.status === 204) {
                console.info(`[OK] vulnerabilty alerts for ${owner}/${repo.name} already enabled`)
                vulnerability_alerts_synced = true
            } else {
                console.warn(`[WARN] vulnerability alerts for ${owner}/${repo.name} disabled, attempting to enable`)
                const alerts_resp = await gh.request('PUT /repos/{owner}/${repo}/vulnerability-alerts', {
                    owner,
                    repo: repo.name,
                    mediaType: {
                        previews: [
                            'dorian',
                        ],
                    },
                })

                if (resp.status === 204) {
                    console.info(`[OK] vulnerabilty alerts for ${owner}/${repo.name} enabled`)
                    vulnerability_alerts_synced = true
                } else {
                    console.error(`[FAIL] could not enable vulnerability alerts for ${owner}/${repo.name}`)
                    vulnerability_alerts_synced = false
                }
            }
        } catch (error) {
            console.error(error)
        }

        return {
            ...repo,
            vulnerability_alerts_synced,
        }
    }
}
